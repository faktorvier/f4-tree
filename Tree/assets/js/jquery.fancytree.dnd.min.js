(function(e,r,t,a){"use strict";function n(e){return 0===e?"":e>0?"+"+e:""+e}function o(r){var t=r.options.dnd||null,a=r.options.glyph||null;t&&d(),t&&t.dragStart&&r.widget.element.draggable(e.extend({addClasses:!1,appendTo:r.$container,containment:!1,delay:0,distance:4,revert:!1,scroll:!0,scrollSpeed:7,scrollSensitivity:10,connectToFancytree:!0,helper:function(r){var t,n,o,d=e.ui.fancytree.getNode(r.target);return d?(o=d.tree.options.dnd,n=e(d.span),t=e("<div class='fancytree-drag-helper'><span class='fancytree-drag-helper-img' /></div>").css({zIndex:3,position:"relative"}).append(n.find("span.fancytree-title").clone()),t.data("ftSourceNode",d),a&&t.find(".fancytree-drag-helper-img").addClass(a.map.dragHelper),o.initHelper&&o.initHelper.call(d.tree,d,{node:d,tree:d.tree,originalEvent:r,ui:{helper:t}}),t):"<div>ERROR?: helper requested but sourceNode not found</div>"},start:function(e,r){var t=r.helper.data("ftSourceNode");return!!t}},r.options.dnd.draggable)),t&&t.dragDrop&&r.widget.element.droppable(e.extend({addClasses:!1,tolerance:"intersect",greedy:!1},r.options.dnd.droppable))}function d(){l||(e.ui.plugin.add("draggable","connectToFancytree",{start:function(r,t){var a=e(this).data("ui-draggable")||e(this).data("draggable"),n=t.helper.data("ftSourceNode")||null;if(n)return a.offset.click.top=-2,a.offset.click.left=16,n.tree.ext.dnd._onDragEvent("start",n,null,r,t,a)},drag:function(r,t){var a,n,o,d=e(this).data("ui-draggable")||e(this).data("draggable"),l=t.helper.data("ftSourceNode")||null,s=t.helper.data("ftTargetNode")||null,i=e.ui.fancytree.getNode(r.target),p=l&&l.tree.options.dnd;return r.target&&!i&&(n=e(r.target).closest("div.fancytree-drag-helper,#fancytree-drop-marker").length>0)?(o=l||s||e.ui.fancytree,void o.debug("Drag event over helper: ignored.")):(t.helper.data("ftTargetNode",i),p&&p.updateHelper&&(a=l.tree._makeHookContext(l,r,{otherNode:i,ui:t,draggable:d,dropMarker:e("#fancytree-drop-marker")}),p.updateHelper.call(l.tree,l,a)),s&&s!==i&&s.tree.ext.dnd._onDragEvent("leave",s,l,r,t,d),void(i&&i.tree.options.dnd.dragDrop&&(i===s?i.tree.ext.dnd._onDragEvent("over",i,l,r,t,d):i.tree.ext.dnd._onDragEvent("enter",i,l,r,t,d))))},stop:function(r,t){var a,n=e(this).data("ui-draggable")||e(this).data("draggable"),o=t.helper.data("ftSourceNode")||null,d=t.helper.data("ftTargetNode")||null,l="mouseup"===r.type&&1===r.which;l||(a=o||d||e.ui.fancytree,a.debug("Drag was cancelled")),d&&(l&&d.tree.ext.dnd._onDragEvent("drop",d,o,r,t,n),d.tree.ext.dnd._onDragEvent("leave",d,o,r,t,n)),o&&o.tree.ext.dnd._onDragEvent("stop",o,null,r,t,n)}}),l=!0)}var l=!1,s="fancytree-drop-accept",i="fancytree-drop-after",p="fancytree-drop-before",g="fancytree-drop-over",c="fancytree-drop-reject",u="fancytree-drop-target";e.ui.fancytree.registerExtension({name:"dnd",version:"0.2.0",options:{autoExpandMS:1e3,draggable:null,droppable:null,focusOnClick:!1,preventVoidMoves:!0,preventRecursiveMoves:!0,smartRevert:!0,dragStart:null,dragStop:null,initHelper:null,updateHelper:null,dragEnter:null,dragOver:null,dragDrop:null,dragLeave:null},treeInit:function(r){var t=r.tree;this._superApply(arguments),t.options.dnd.dragStart&&t.$container.on("mousedown",function(t){if(r.options.dnd.focusOnClick){var a=e.ui.fancytree.getNode(t);a&&a.debug("Re-enable focus that was prevented by jQuery UI draggable."),setTimeout(function(){e(t.target).closest(":tabbable").focus()},10)}}),o(t)},_setDndStatus:function(r,t,a,o,d){var l=0,f="center",v=this._local,h=this.options.glyph||null,b=r?e(r.span):null,y=e(t.span);if(v.$dropMarker||(v.$dropMarker=e("<div id='fancytree-drop-marker'></div>").hide().css({"z-index":1e3}).prependTo(e(this.$div).parent()),h&&v.$dropMarker.addClass(h.map.dropMarker)),"after"===o||"before"===o||"over"===o){switch(o){case"before":f="top";break;case"after":f="bottom";break;default:l=8}v.$dropMarker.toggleClass(i,"after"===o).toggleClass(g,"over"===o).toggleClass(p,"before"===o).show().position(e.ui.fancytree.fixPositionOptions({my:"left"+n(l)+" center",at:"left "+f,of:y}))}else v.$dropMarker.hide();b&&b.toggleClass(s,d===!0).toggleClass(c,d===!1),y.toggleClass(u,"after"===o||"before"===o||"over"===o).toggleClass(i,"after"===o).toggleClass(p,"before"===o).toggleClass(s,d===!0).toggleClass(c,d===!1),a.toggleClass(s,d===!0).toggleClass(c,d===!1)},_onDragEvent:function(r,n,o,d,l,s){"over"!==r&&this.debug("tree.ext.dnd._onDragEvent(%s, %o, %o) - %o",r,n,o,this);var i,p,g,c,u,f,v,h=this.options,b=h.dnd,y=this._makeHookContext(n,d,{otherNode:o,ui:l,draggable:s}),k=null,m=this,x=e(n.span);switch(b.smartRevert&&(s.options.revert="invalid"),r){case"start":n.isStatusNode()?k=!1:b.dragStart&&(k=b.dragStart(n,y)),k===!1?(this.debug("tree.dragStart() cancelled"),l.helper.trigger("mouseup").hide()):(x.addClass("fancytree-drag-source"),e(t).on("keydown.fancytree-dnd,mousedown.fancytree-dnd",function(r){"keydown"===r.type&&r.which===e.ui.keyCode.ESCAPE?m.ext.dnd._cancelDrag():"mousedown"===r.type&&m.ext.dnd._cancelDrag()}));break;case"enter":v=(!b.preventRecursiveMoves||!n.isDescendantOf(o))&&(b.dragEnter?b.dragEnter(n,y):null),k=!!v&&(e.isArray(v)?{over:e.inArray("over",v)>=0,before:e.inArray("before",v)>=0,after:e.inArray("after",v)>=0}:{over:v===!0||"over"===v,before:v===!0||"before"===v,after:v===!0||"after"===v}),l.helper.data("enterResponse",k),this.debug("helper.enterResponse: %o",k);break;case"over":u=l.helper.data("enterResponse"),f=null,u===!1||("string"==typeof u?f=u:(p=x.offset(),g={x:d.pageX-p.left,y:d.pageY-p.top},c={x:g.x/x.width(),y:g.y/x.height()},u.after&&c.y>.75?f="after":!u.over&&u.after&&c.y>.5?f="after":u.before&&c.y<=.25?f="before":!u.over&&u.before&&c.y<=.5?f="before":u.over&&(f="over"),b.preventVoidMoves&&(n===o?(this.debug("    drop over source node prevented"),f=null):"before"===f&&o&&n===o.getNextSibling()?(this.debug("    drop after source node prevented"),f=null):"after"===f&&o&&n===o.getPrevSibling()?(this.debug("    drop before source node prevented"),f=null):"over"===f&&o&&o.parent===n&&o.isLastSibling()&&(this.debug("    drop last child over own parent prevented"),f=null)),l.helper.data("hitMode",f))),"over"===f&&b.autoExpandMS&&n.hasChildren()!==!1&&!n.expanded&&n.scheduleAction("expand",b.autoExpandMS),f&&b.dragOver&&(y.hitMode=f,k=b.dragOver(n,y)),i=k!==!1&&null!==f,b.smartRevert&&(s.options.revert=!i),this._local._setDndStatus(o,n,l.helper,f,i);break;case"drop":f=l.helper.data("hitMode"),f&&b.dragDrop&&(y.hitMode=f,b.dragDrop(n,y));break;case"leave":n.scheduleAction("cancel"),l.helper.data("enterResponse",null),l.helper.data("hitMode",null),this._local._setDndStatus(o,n,l.helper,"out",a),b.dragLeave&&b.dragLeave(n,y);break;case"stop":x.removeClass("fancytree-drag-source"),e(t).off(".fancytree-dnd"),b.dragStop&&b.dragStop(n,y);break;default:e.error("Unsupported drag event: "+r)}return k},_cancelDrag:function(){var r=e.ui.ddmanager.current;r&&r.cancel()}})})(jQuery,window,document);
